/*
 * (C) Copyright 2024, SECO Mind Srl
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/*
 * @file astarte-device-sdk-zephyr/tests/lib/astarte_device_sdk/unit/bson/src/main.c
 *
 * @details This test suite verifies that the methods provided with the unit_testable_component
 * module works correctly.
 *
 * @note This should be run with the latest version of zephyr present on master (or 3.6.0)
 */

#include <zephyr/ztest.h>

#include <astarte_device_sdk/bson_serializer.h>
#include <lib/astarte_device_sdk/bson_serializer.c>

const uint8_t serialized_bson_empty_document[] = { 0x05, 0x00, 0x00, 0x00, 0x00 };

/** Complete BSON corresponds to:
 * {
 *     "element double": 42.3,
 *     "element string": "hello world",
 *     "element binary": b'bin encoded string',
 *     "element bool false": False,
 *     "element bool true": True,
 *     "element UTC datetime": datetime.now(timezone.utc),
 *     "element int32":10,
 *     "element int64":17179869184,
 *     "element double array": [10.32, 323.44],
 *     "element string array": ["hello", "world"],
 *     "element binary array": [b'a', b'a', b'cd'],
 *     "element bool array": [False, True],
 *     "element UTC datetime array": [datetime.now(timezone.utc)],
 *     "element int32 array": [342, 532, -324, 4323],
 *     "element int64 array": [-(2**32 + 2845), (2**32 + 854795484), (2**32 + 11), (2**32 + 654)],
 * }
 */

const uint8_t serialized_bson_complete_document[] = { 0x3b, 0x02, 0x00, 0x00, 0x01, 0x65, 0x6c,
    0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x64, 0x6f, 0x75, 0x62, 0x6c, 0x65, 0x00, 0x66, 0x66, 0x66,
    0x66, 0x66, 0x26, 0x45, 0x40, 0x02, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x73, 0x74,
    0x72, 0x69, 0x6e, 0x67, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x77,
    0x6f, 0x72, 0x6c, 0x64, 0x00, 0x05, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x62, 0x69,
    0x6e, 0x61, 0x72, 0x79, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x62, 0x69, 0x6e, 0x20, 0x65, 0x6e,
    0x63, 0x6f, 0x64, 0x65, 0x64, 0x20, 0x73, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x08, 0x65, 0x6c, 0x65,
    0x6d, 0x65, 0x6e, 0x74, 0x20, 0x62, 0x6f, 0x6f, 0x6c, 0x20, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x00,
    0x00, 0x08, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x62, 0x6f, 0x6f, 0x6c, 0x20, 0x74,
    0x72, 0x75, 0x65, 0x00, 0x01, 0x09, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x55, 0x54,
    0x43, 0x20, 0x64, 0x61, 0x74, 0x65, 0x74, 0x69, 0x6d, 0x65, 0x00, 0x3e, 0x20, 0x93, 0x9f, 0x88,
    0x01, 0x00, 0x00, 0x10, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x69, 0x6e, 0x74, 0x33,
    0x32, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x12, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x69,
    0x6e, 0x74, 0x36, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x65, 0x6c,
    0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x64, 0x6f, 0x75, 0x62, 0x6c, 0x65, 0x20, 0x61, 0x72, 0x72,
    0x61, 0x79, 0x00, 0x1b, 0x00, 0x00, 0x00, 0x01, 0x30, 0x00, 0xa4, 0x70, 0x3d, 0x0a, 0xd7, 0xa3,
    0x24, 0x40, 0x01, 0x31, 0x00, 0xd7, 0xa3, 0x70, 0x3d, 0x0a, 0x37, 0x74, 0x40, 0x00, 0x04, 0x65,
    0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x73, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x20, 0x61, 0x72,
    0x72, 0x61, 0x79, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x02, 0x30, 0x00, 0x06, 0x00, 0x00, 0x00, 0x68,
    0x65, 0x6c, 0x6c, 0x6f, 0x00, 0x02, 0x31, 0x00, 0x06, 0x00, 0x00, 0x00, 0x77, 0x6f, 0x72, 0x6c,
    0x64, 0x00, 0x00, 0x04, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x62, 0x69, 0x6e, 0x61,
    0x72, 0x79, 0x20, 0x61, 0x72, 0x72, 0x61, 0x79, 0x00, 0x21, 0x00, 0x00, 0x00, 0x05, 0x30, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x61, 0x05, 0x31, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x61, 0x05,
    0x32, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x63, 0x64, 0x00, 0x04, 0x65, 0x6c, 0x65, 0x6d, 0x65,
    0x6e, 0x74, 0x20, 0x62, 0x6f, 0x6f, 0x6c, 0x20, 0x61, 0x72, 0x72, 0x61, 0x79, 0x00, 0x0d, 0x00,
    0x00, 0x00, 0x08, 0x30, 0x00, 0x00, 0x08, 0x31, 0x00, 0x01, 0x00, 0x04, 0x65, 0x6c, 0x65, 0x6d,
    0x65, 0x6e, 0x74, 0x20, 0x55, 0x54, 0x43, 0x20, 0x64, 0x61, 0x74, 0x65, 0x74, 0x69, 0x6d, 0x65,
    0x20, 0x61, 0x72, 0x72, 0x61, 0x79, 0x00, 0x10, 0x00, 0x00, 0x00, 0x09, 0x30, 0x00, 0x5b, 0x99,
    0x1a, 0xd8, 0x88, 0x01, 0x00, 0x00, 0x00, 0x04, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20,
    0x69, 0x6e, 0x74, 0x33, 0x32, 0x20, 0x61, 0x72, 0x72, 0x61, 0x79, 0x00, 0x21, 0x00, 0x00, 0x00,
    0x10, 0x30, 0x00, 0x56, 0x01, 0x00, 0x00, 0x10, 0x31, 0x00, 0x14, 0x02, 0x00, 0x00, 0x10, 0x32,
    0x00, 0xbc, 0xfe, 0xff, 0xff, 0x10, 0x33, 0x00, 0xe3, 0x10, 0x00, 0x00, 0x00, 0x04, 0x65, 0x6c,
    0x65, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x69, 0x6e, 0x74, 0x36, 0x34, 0x20, 0x61, 0x72, 0x72, 0x61,
    0x79, 0x00, 0x31, 0x00, 0x00, 0x00, 0x12, 0x30, 0x00, 0xe3, 0xf4, 0xff, 0xff, 0xfe, 0xff, 0xff,
    0xff, 0x12, 0x31, 0x00, 0xdc, 0x24, 0xf3, 0x32, 0x01, 0x00, 0x00, 0x00, 0x12, 0x32, 0x00, 0x0b,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x12, 0x33, 0x00, 0x8e, 0x02, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00 };

ZTEST(astarte_device_sdk_bson, test_bson_serializer_empty_document)
{
    bson_serializer_handle_t bson = bson_serializer_new();
    bson_serializer_append_end_of_document(bson);

    int ser_bson_size = 0;
    const void *ser_bson = bson_serializer_get_document(bson, &ser_bson_size);

    zassert_equal(sizeof(serialized_bson_empty_document), ser_bson_size,
        "serialized_bson_empty_document size != from expected ser_bson_size");
    zassert_mem_equal(serialized_bson_empty_document, (const uint8_t *) ser_bson,
        sizeof(serialized_bson_empty_document),
        "serialized_bson_empty_document and ser_bson not have same contents");

    bson_serializer_destroy(bson);
}

ZTEST(astarte_device_sdk_bson, test_bson_serializer_complete_document)
{
    bson_serializer_handle_t bson = bson_serializer_new();

    bson_serializer_append_double(bson, "element double", (double) 42.3);
    bson_serializer_append_string(bson, "element string", "hello world");
    const uint8_t bin[] = { 0x62, 0x69, 0x6e, 0x20, 0x65, 0x6e, 0x63, 0x6f, 0x64, 0x65, 0x64, 0x20,
        0x73, 0x74, 0x72, 0x69, 0x6e, 0x67 };
    bson_serializer_append_binary(bson, "element binary", bin, sizeof(bin));
    bson_serializer_append_boolean(bson, "element bool false", false);
    bson_serializer_append_boolean(bson, "element bool true", true);
    bson_serializer_append_datetime(bson, "element UTC datetime", 1686304399422);
    bson_serializer_append_int32(bson, "element int32", 10);
    bson_serializer_append_int64(bson, "element int64", 17179869184);

    const double arr_d[] = { 10.32, 323.44 };
    bson_serializer_append_double_array(bson, "element double array", arr_d, 2);
    const char *arr_s[] = { "hello", "world" };
    bson_serializer_append_string_array(bson, "element string array", arr_s, 2);
    const uint8_t bin_1[] = { 0x61 };
    const uint8_t bin_2[] = { 0x61 };
    const uint8_t bin_3[] = { 0x63, 0x64 };
    const uint8_t *arr_bin[] = { bin_1, bin_2, bin_3 };
    const int arr_sizes[] = { 1, 1, 2 };
    bson_serializer_append_binary_array(
        bson, "element binary array", (const void *const *) arr_bin, arr_sizes, 3);
    const bool arr_bool[] = { false, true };
    bson_serializer_append_boolean_array(bson, "element bool array", arr_bool, 2);
    const int64_t arr_dt[] = { 1687252801883 };
    bson_serializer_append_datetime_array(bson, "element UTC datetime array", arr_dt, 1);
    const int32_t arr_int32[] = { 342, 532, -324, 4323 };
    bson_serializer_append_int32_array(bson, "element int32 array", arr_int32, 4);
    const int64_t arr_int64[] = { -4294970141, 5149762780, 4294967307, 4294967950 };
    bson_serializer_append_int64_array(bson, "element int64 array", arr_int64, 4);

    bson_serializer_append_end_of_document(bson);

    int ser_bson_size = 0;
    const void *ser_bson = bson_serializer_get_document(bson, &ser_bson_size);

    zassert_equal(sizeof(serialized_bson_complete_document), ser_bson_size,
        "serialized_bson_complete_document size != from expected ser_bson_size");
    zassert_mem_equal(serialized_bson_complete_document, (const uint8_t *) ser_bson,
        sizeof(serialized_bson_complete_document),
        "serialized_bson_complete_document and ser_bson not have same contents");

    bson_serializer_destroy(bson);
}
